// =====================
// åˆæœŸåŒ–
// =====================
liff
  .init({ liffId: LIFF_ID })
  .then(route)
  .catch(() => {
    document.getElementById("app").innerHTML = "LIFFåˆæœŸåŒ–å¤±æ•—";
  });

// =====================
// ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
// =====================
function route() {
  const page = new URLSearchParams(location.search).get("page");

  if (page === "add") renderAdd();
  else if (page === "done") renderDone();
  else if (page === "register") renderRegister();
  else renderMenu();
}

// =====================
// ãƒˆãƒ¼ã‚¹ãƒˆ
// =====================
function showToast(msg) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), 2000);
}

// =====================
// ãƒ¡ãƒ‹ãƒ¥ãƒ¼
// =====================
function renderMenu() {
  app.innerHTML = `
    <h2>ğŸ“˜ å®¿é¡Œç®¡ç†</h2>
    <a class="menu-btn" href="?page=add">â• å®¿é¡Œè¿½åŠ </a>
    <a class="menu-btn" href="?page=done">âœ… å®Œäº†ç™»éŒ²</a>
    <a class="menu-btn" href="?page=register">ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²</a>
  `;
}

// =====================
// ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
// =====================
function renderRegister() {
  app.innerHTML = `
    <h2>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²</h2>
    <button id="regBtn">ç™»éŒ²ã™ã‚‹</button>
  `;

  document.getElementById("regBtn").onclick = async () => {
    const userId = await getUserId();
    await post({ action: "register", userId });
    showToast("ç™»éŒ²ã—ã¾ã—ãŸ");
    setTimeout(() => liff.closeWindow(), 1500);
  };
}

// =====================
// å®¿é¡Œè¿½åŠ 
// =====================
function renderAdd() {
  const subjects = [
    "å›½èª",
    "æ•°å­¦",
    "ç†ç§‘",
    "ç¤¾ä¼š",
    "è‹±èª",
    "éŸ³æ¥½",
    "ç¾è¡“",
    "ä¿ä½“",
    "ãã®ä»–",
  ];

  app.innerHTML = `
    <h2>å®¿é¡Œè¿½åŠ </h2>

    <div class="subjects">
      ${subjects.map((s) => `<button class="sub">${s}</button>`).join("")}
    </div>

    <input id="text" placeholder="å®¿é¡Œå†…å®¹" />
    <input id="date" type="date" />

    <button id="addBtn">è¿½åŠ </button>
  `;

  let subject = "";

  document.querySelectorAll(".sub").forEach((btn) => {
    btn.onclick = () => {
      document.querySelectorAll(".sub").forEach((b) =>
        b.classList.remove("active")
      );
      btn.classList.add("active");
      subject = btn.textContent;
    };
  });

  document.getElementById("addBtn").onclick = async () => {
    const text = document.getElementById("text").value;
    const rawDate = document.getElementById("date").value;

    if (!subject || !text || !rawDate) return;

    const d = new Date(rawDate);
    const date = `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()}`;

    await post({ action: "addHomework", subject, text, date });

    showToast("å®¿é¡Œã‚’è¿½åŠ ã—ã¾ã—ãŸ");
    setTimeout(() => liff.closeWindow(), 1500);
  };
}

// =====================
// å®Œäº†ç™»éŒ²ï¼ˆæœ€é‡è¦ï¼‰
// =====================
async function renderDone() {
  app.innerHTML = `
    <h2>å®Œäº†ç™»éŒ²</h2>
    <div id="list"></div>
    <button id="doneBtn">å®Œäº†</button>
  `;

  const userId = await getUserId();

  // â˜… GASï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼é€²æ—ç®¡ç†ã‚·ãƒ¼ãƒˆã€Œ3è¡Œç›®ãƒ»æ”¹è¡ŒåŒºåˆ‡ã‚Šã€
  const undoneList = await post({
    action: "getUndoneHomework",
    userId,
  });

  const listDiv = document.getElementById("list");

  listDiv.innerHTML = undoneList
    .map(
      (v) => `
      <label class="check">
        <input type="checkbox" value="${v}">
        <span>${v}</span>
      </label>
    `
    )
    .join("");

  document.getElementById("doneBtn").onclick = async () => {
    const checked = [...document.querySelectorAll("input:checked")].map(
      (i) => i.value
    );

    if (!checked.length) return;

    await post({
      action: "doneHomework",
      userId,
      doneList: checked,
    });

    showToast("å®Œäº†ã—ã¾ã—ãŸï¼");
    setTimeout(() => liff.closeWindow(), 1500);
  };
}


