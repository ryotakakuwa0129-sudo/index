<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>å®¿é¡Œç®¡ç†</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body {
  font-family: sans-serif;
  padding: 12px;
  background: #f7f7f7;
}

h2 { margin-bottom: 4px; }
h3 { margin-top: 18px; }

#status {
  margin-bottom: 10px;
  font-size: 14px;
  color: #555;
}

input, button {
  width: 100%;
  padding: 10px;
  margin-top: 6px;
  font-size: 16px;
}

.subject-buttons button {
  width: auto;
  margin: 4px;
  background: #e0f0ff;
  border: none;
  border-radius: 6px;
}

.subject-buttons button.active {
  background: #4a90e2;
  color: white;
}

.action-btn {
  background: #4caf50;
  color: white;
  border: none;
  border-radius: 6px;
}

.done-btn {
  background: #ff7043;
  color: white;
  border: none;
  border-radius: 6px;
}

.hw {
  background: white;
  border-radius: 6px;
  padding: 8px;
  margin-top: 6px;
}
</style>
</head>

<body>
<h2>ğŸ“˜ å®¿é¡Œç®¡ç†</h2>
<div id="status">èª­ã¿è¾¼ã¿ä¸­â€¦</div>

<h3>â• å®¿é¡Œè¿½åŠ </h3>

<div>ğŸ“š æ•™ç§‘ã‚’é¸æŠ</div>
<div class="subject-buttons" id="subjects"></div>

<input id="text" placeholder="å®¿é¡Œã®å†…å®¹">
<input id="date" type="date">

<button class="action-btn" onclick="addHomework()">å®¿é¡Œã‚’è¿½åŠ </button>

<h3>â˜‘ æœªå®Œäº†å®¿é¡Œ</h3>
<div id="list"></div>
<button class="done-btn" onclick="doneHomework()">ãƒã‚§ãƒƒã‚¯ã—ãŸå®¿é¡Œã‚’å®Œäº†</button>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbz910FJbvEKdMV-8dEGncfx2YocZHmNVeuyZHRA26c6SmqEaBEgPzwURfl1fQonvpTbpQ/exec";
const LIFF_ID = "2008725002-jHJsEKRx";

let userId = "";
let selectedSubject = "";

const SUBJECT_LIST = ["å›½èª","æ•°å­¦","è‹±èª","ç†ç§‘","ç¤¾ä¼š","ãã®ä»–"];

document.addEventListener("DOMContentLoaded", init);

async function init() {
  try {
    await liff.init({ liffId: LIFF_ID });

    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }

    const profile = await liff.getProfile();
    userId = profile.userId;

    makeSubjectButtons();
    await checkUser();
    await loadUndone();

    document.getElementById("status").innerText = "æº–å‚™å®Œäº†";
  } catch (e) {
    document.getElementById("status").innerText = "åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼";
    console.error(e);
  }
}

function makeSubjectButtons() {
  const box = document.getElementById("subjects");
  SUBJECT_LIST.forEach(s => {
    const btn = document.createElement("button");
    btn.innerText = s;
    btn.onclick = () => selectSubject(s, btn);
    box.appendChild(btn);
  });
}

function selectSubject(subject, btn) {
  selectedSubject = subject;
  document.querySelectorAll(".subject-buttons button")
    .forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
}

async function post(data) {
  const res = await fetch(GAS_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });
  return res.json();
}

async function checkUser() {
  const res = await post({ action: "checkUser", userId });
  if (!res.registered) {
    await post({ action: "register", userId });
  }
}

async function addHomework() {
  const text = document.getElementById("text").value;
  const date = document.getElementById("date").value;

  if (!selectedSubject || !text || !date) {
    alert("æ•™ç§‘ãƒ»å†…å®¹ãƒ»æ—¥ä»˜ã‚’ã™ã¹ã¦é¸ã‚“ã§ãã ã•ã„");
    return;
  }

  await post({
    action: "addHomework",
    userId,
    subject: selectedSubject,
    text,
    date
  });

  document.getElementById("text").value = "";
  await loadUndone();
  alert("å®¿é¡Œã‚’è¿½åŠ ã—ã¾ã—ãŸ");
}

async function loadUndone() {
  const res = await post({
    action: "getUndoneHomework",
    userId
  });

  const list = document.getElementById("list");
  list.innerHTML = "";

  res.forEach(t => {
    const div = document.createElement("div");
    div.className = "hw";
    div.innerHTML = `
      <label>
        <input type="checkbox" value="${t}">
        ${t}
      </label>`;
    list.appendChild(div);
  });
}

async function doneHomework() {
  const checked = [...document.querySelectorAll("input[type=checkbox]:checked")]
    .map(c => c.value);

  if (checked.length === 0) {
    alert("å®Œäº†ã™ã‚‹å®¿é¡Œã‚’é¸æŠã—ã¦ãã ã•ã„");
    return;
  }

  await post({
    action: "doneHomework",
    userId,
    doneList: checked
  });

  await loadUndone();
  alert("å®Œäº†ã—ã¾ã—ãŸ");
}
</script>
</body>
</html>
