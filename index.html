<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å®¿é¡Œç®¡ç† LIFF</title>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body{
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
  background:#f5f6f8;
  padding:16px;
}
.card{
  background:#fff;
  border-radius:14px;
  padding:18px;
  margin-bottom:16px;
  box-shadow:0 4px 10px rgba(0,0,0,.08);
}
.hidden{ display:none; }
h2{ margin-top:0; }
button{
  width:100%;
  padding:14px;
  background:#06c755;
  color:#fff;
  border:none;
  border-radius:10px;
  font-size:16px;
  margin-top:12px;
}
select,input{
  width:100%;
  padding:12px;
  margin-top:10px;
  font-size:16px;
}
.checkbox{
  display:flex;
  align-items:center;
  gap:8px;
  margin-top:8px;
}
.notice{
  color:#666;
  font-size:14px;
}
</style>
</head>

<body>

<!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ² -->
<div id="registerCard" class="card hidden">
  <h2>ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²</h2>
  <p class="notice">åˆå›ã®ã¿ç™»éŒ²ãŒå¿…è¦ã§ã™</p>
  <button onclick="register()">ç™»éŒ²ã™ã‚‹</button>
</div>

<!-- å®¿é¡Œè¿½åŠ  -->
<div id="addCard" class="card hidden">
  <h2>ğŸ“˜ å®¿é¡Œè¿½åŠ </h2>

  <select id="subject">
    <option value="">æ•™ç§‘ã‚’é¸æŠ</option>
    <option>å›½èª</option>
    <option>è‹±èª</option>
    <option>ç¤¾ä¼š</option>
    <option>æ•°å­¦</option>
    <option>ç†ç§‘</option>
    <option>ä¿ä½“</option>
    <option>ç¾è¡“</option>
    <option>éŸ³æ¥½</option>
    <option>U</option>
    <option>ãã®ä»–</option>
  </select>

  <input id="text" placeholder="å®¿é¡Œå†…å®¹">
  <input id="date" type="date">
  <button onclick="addHomework()">è¿½åŠ </button>
</div>

<!-- å®Œäº†ç™»éŒ² -->
<div id="doneCard" class="card hidden">
  <h2>âœ… å®Œäº†ç™»éŒ²</h2>
  <div id="undoneList">èª­ã¿è¾¼ã¿ä¸­...</div>
  <button onclick="submitDone()">å®Œäº†ã«ã™ã‚‹</button>
</div>

<script>
const LIFF_ID = "2008725002-jHJsEKRx";
const GAS_URL  = "https://script.google.com/macros/s/AKfycbz910FJbvEKdMV-8dEGncfx2YocZHmNVeuyZHRA26c6SmqEaBEgPzwURfl1fQonvpTbpQ/exec";

let userId = "";
let undone = [];

const qs = id => document.getElementById(id);

function show(id){
  ["registerCard","addCard","doneCard"].forEach(v=>qs(v).classList.add("hidden"));
  qs(id).classList.remove("hidden");
}

/* API é€šä¿¡ï¼ˆçµ±ä¸€ï¼‰ */
async function api(data, json=false){
  const res = await fetch(GAS_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(data)
  });
  return json ? res.json() : res.text();
}

async function init(){
  try{
    await liff.init({ liffId: LIFF_ID });

    if(!liff.isInClient()){
      document.body.innerHTML = "<h3>LINEã‚¢ãƒ—ãƒªå†…ã‹ã‚‰é–‹ã„ã¦ãã ã•ã„</h3>";
      return;
    }

    if(!liff.isLoggedIn()){
      liff.login();
      return;
    }

    const profile = await liff.getProfile();
    userId = profile.userId;

    const mode = new URLSearchParams(location.search).get("mode") || "add";

    const check = await api({ action:"checkUser", userId }, true);
    if(!check.registered){
      show("registerCard");
      return;
    }

    if(mode === "done"){
      show("doneCard");
      loadUndone();
    }else{
      show("addCard");
    }

  }catch(e){
    document.body.innerHTML = "<pre>"+e+"</pre>";
  }
}

async function register(){
  await api({ action:"register", userId });
  liff.closeWindow();
}

async function addHomework(){
  const s = qs("subject").value;
  const t = qs("text").value;
  const d = qs("date").value;

  if(!s || !t || !d){
    alert("ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }

  await api({
    action:"addHomework",
    userId,
    subject:s,
    text:`${s}:${t}ï¼ˆæœŸé™${d}ï¼‰`,
    date:d
  });

  liff.closeWindow();
}

async function loadUndone(){
  undone = await api({ action:"getUndoneHomework", userId }, true);
  const area = qs("undoneList");
  area.innerHTML = "";

  if(undone.length === 0){
    area.innerHTML = "<p class='notice'>æœªå®Œäº†ã®å®¿é¡Œã¯ã‚ã‚Šã¾ã›ã‚“</p>";
    return;
  }

  undone.forEach((t,i)=>{
    const div = document.createElement("div");
    div.className = "checkbox";

    const cb = document.createElement("input");
    cb.type="checkbox";
    cb.dataset.index=i;

    const label = document.createElement("label");
    label.textContent=t;

    div.appendChild(cb);
    div.appendChild(label);
    area.appendChild(div);
  });
}

async function submitDone(){
  const checked = [...document.querySelectorAll("#undoneList input:checked")];
  if(!checked.length){
    alert("é¸æŠã—ã¦ãã ã•ã„");
    return;
  }

  for(const c of checked){
    await api({
      action:"doneHomework",
      userId,
      text:undone[c.dataset.index]
    });
  }

  liff.closeWindow();
}

init();
</script>

</body>
</html>
