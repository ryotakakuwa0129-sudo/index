<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>LIFFå®¿é¡Œç®¡ç†</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body {
  font-family: sans-serif;
  text-align: center;
  background: #f5f5f5;
}
h1 { font-size: 28px; }
.box {
  background: white;
  margin: 20px auto;
  padding: 20px;
  width: 90%;
  max-width: 420px;
  border-radius: 12px;
}
button {
  font-size: 18px;
  padding: 12px;
  width: 100%;
  margin-top: 10px;
}
input, textarea, select {
  font-size: 16px;
  width: 100%;
  padding: 10px;
}
</style>
</head>

<body>
<h1>ğŸ“˜ LIFFå®¿é¡Œç®¡ç†</h1>

<div id="register" class="box">
  <p>æœ€åˆã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã‚’ã—ã¦ãã ã•ã„</p>
  <button onclick="register()">ç™»éŒ²ã™ã‚‹</button>
</div>

<div id="add" class="box" style="display:none">
  <h2>å®¿é¡Œè¿½åŠ </h2>
  <select id="subject">
    <option>å›½èª</option><option>æ•°å­¦</option><option>è‹±èª</option>
    <option>ç†ç§‘</option><option>ç¤¾ä¼š</option><option>ãã®ä»–</option>
  </select>
  <textarea id="content" placeholder="å®¿é¡Œå†…å®¹"></textarea>
  <input type="date" id="deadline">
  <button onclick="addHomework()">è¿½åŠ </button>
</div>

<div id="complete" class="box" style="display:none">
  <h2>å®¿é¡Œå®Œäº†ç™»éŒ²</h2>
  <textarea id="done" placeholder="å®Œäº†ã—ãŸå®¿é¡Œï¼ˆæ”¹è¡Œï¼‰"></textarea>
  <button onclick="complete()">é€ä¿¡</button>
</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbz910FJbvEKdMV-8dEGncfx2YocZHmNVeuyZHRA26c6SmqEaBEgPzwURfl1fQonvpTbpQ/exec";
let userId = "";

async function init() {
  await liff.init({ liffId: "2008725002-jHJsEKRx" });
  userId = liff.getContext().userId;

  const res = await fetch(GAS_URL, {
    method: "POST",
    body: JSON.stringify({ type:"checkRegister", userId })
  });
  const json = await res.json();

  const page = new URLSearchParams(location.search).get("page") || "register";

  if (!json.registered) {
    show("register");
  } else {
    show(page);
  }
}

function show(id) {
  ["register","add","complete"].forEach(v=>{
    document.getElementById(v).style.display="none";
  });
  document.getElementById(id).style.display="block";
}

async function register() {
  await fetch(GAS_URL, {
    method:"POST",
    body:JSON.stringify({ type:"register", userId })
  });
  alert("ç™»éŒ²å®Œäº†ï¼");
  show("add");
}

async function addHomework() {
  await fetch(GAS_URL,{
    method:"POST",
    body:JSON.stringify({
      type:"addHomework",
      subject:subject.value,
      content:content.value,
      deadline:deadline.value
    })
  });
  alert("è¿½åŠ ã—ã¾ã—ãŸï¼");
}

async function complete() {
  const list = done.value.split("\n").filter(v=>v);
  await fetch(GAS_URL,{
    method:"POST",
    body:JSON.stringify({
      type:"complete",
      userId,
      done:list
    })
  });
  alert("å®Œäº†ç™»éŒ²ã—ã¾ã—ãŸï¼");
}

init();
</script>
</body>
</html>
