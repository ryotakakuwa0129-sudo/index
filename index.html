<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>å®¿é¡Œç®¡ç† LIFF</title>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
  background: #f5f6f8;
  margin: 0;
  padding: 16px;
}
.card {
  background: #fff;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 16px;
  box-shadow: 0 2px 6px rgba(0,0,0,.08);
}
h2 { margin-top: 0; }
input, select, button {
  width: 100%;
  padding: 10px;
  margin-top: 8px;
  font-size: 16px;
}
button {
  background: #06c755;
  color: #fff;
  border: none;
  border-radius: 8px;
}
.checkbox {
  display: flex;
  align-items: center;
  margin-top: 8px;
}
.checkbox input {
  width: auto;
  margin-right: 8px;
}
.hidden { display: none; }
.menu button {
  margin-top: 12px;
}
</style>
</head>

<body>

<!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
<div class="card menu hidden" id="menuView">
  <h2>ğŸ“š å®¿é¡Œç®¡ç†</h2>
  <button onclick="showAdd()">â• å®¿é¡Œè¿½åŠ </button>
  <button onclick="showDone()">âœ… å®Œäº†ç™»éŒ²</button>
</div>

<!-- å®¿é¡Œè¿½åŠ  -->
<div class="card hidden" id="addView">
  <h2>ğŸ“˜ å®¿é¡Œè¿½åŠ </h2>

  <select id="subject">
    <option value="">æ•™ç§‘ã‚’é¸æŠ</option>
    <option value="å›½èª">å›½èª</option>
    <option value="è‹±èª">è‹±èª</option>
    <option value="ç¤¾ä¼š">ç¤¾ä¼š</option>
    <option value="æ•°å­¦">æ•°å­¦</option>
    <option value="ç†ç§‘">ç†ç§‘</option>
    <option value="ä¿ä½“">ä¿ä½“</option>
    <option value="ç¾è¡“">ç¾è¡“</option>
    <option value="éŸ³æ¥½">éŸ³æ¥½</option>
    <option value="ãã®ä»–">ãã®ä»–</option>
  </select>

  <input id="homeworkText" placeholder="å®¿é¡Œå†…å®¹" />
  <input id="deadline" type="date" />

  <button onclick="addHomework()">è¿½åŠ </button>
  <button onclick="backMenu()">æˆ»ã‚‹</button>
</div>

<!-- å®Œäº†ç™»éŒ² -->
<div class="card hidden" id="doneView">
  <h2>âœ… å®Œäº†ç™»éŒ²</h2>
  <div id="undoneList">èª­ã¿è¾¼ã¿ä¸­...</div>
  <button onclick="submitDone()">å®Œäº†ã«ã™ã‚‹</button>
  <button onclick="backMenu()">æˆ»ã‚‹</button>
</div>

<script>
const LIFF_ID = "2008725002-jHJsEKRx";
const GAS_API_URL = "https://script.google.com/macros/s/AKfycbz910FJbvEKdMV-8dEGncfx2YocZHmNVeuyZHRA26c6SmqEaBEgPzwURfl1fQonvpTbpQ/exec";

let userId = "";
let undoneHomework = [];

/* --------------------
  åˆæœŸåŒ–
-------------------- */
async function init() {
  await liff.init({ liffId: LIFF_ID });

  if (!liff.isLoggedIn()) {
    liff.login();
    return;
  }

  const profile = await liff.getProfile();
  userId = profile.userId;

  // ğŸ”¹ è‡ªå‹•ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
  await postApi({ action: "register", userId });

  showMenu();
}

/* --------------------
  ç”»é¢åˆ¶å¾¡
-------------------- */
function hideAll() {
  document.querySelectorAll(".card").forEach(v => v.classList.add("hidden"));
}

function showMenu() {
  hideAll();
  document.getElementById("menuView").classList.remove("hidden");
}

function showAdd() {
  hideAll();
  document.getElementById("addView").classList.remove("hidden");
}

async function showDone() {
  hideAll();
  document.getElementById("doneView").classList.remove("hidden");
  await loadUndone();
}

function backMenu() {
  showMenu();
}

/* --------------------
  API é€šä¿¡
-------------------- */
async function postApi(data) {
  await fetch(GAS_API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });
}

async function postApiJson(data) {
  const res = await fetch(GAS_API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });
  return await res.json();
}

/* --------------------
  å®¿é¡Œè¿½åŠ 
-------------------- */
async function addHomework() {
  const subject = document.getElementById("subject").value;
  const text = document.getElementById("homeworkText").value.trim();
  const deadline = document.getElementById("deadline").value;

  if (!subject || !text || !deadline) {
    alert("ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }

  await postApi({
    action: "addHomework",
    userId,
    subject,
    text,
    deadline
  });

  alert("å®¿é¡Œã‚’è¿½åŠ ã—ã¾ã—ãŸ");

  document.getElementById("subject").value = "";
  document.getElementById("homeworkText").value = "";
  document.getElementById("deadline").value = "";

  showMenu();
}

/* --------------------
  æœªå®Œäº†å®¿é¡Œå–å¾—
-------------------- */
async function loadUndone() {
  undoneHomework = await postApiJson({
    action: "getUndoneHomework",
    userId
  });

  const area = document.getElementById("undoneList");
  area.innerHTML = "";

  if (!undoneHomework || undoneHomework.length === 0) {
    area.textContent = "æœªå®Œäº†ã®å®¿é¡Œã¯ã‚ã‚Šã¾ã›ã‚“";
    return;
  }

  undoneHomework.forEach((t, i) => {
    const div = document.createElement("div");
    div.className = "checkbox";
    div.innerHTML = `
      <input type="checkbox" id="chk${i}">
      <label for="chk${i}">${t}</label>
    `;
    area.appendChild(div);
  });
}

/* --------------------
  å®Œäº†ç™»éŒ²
-------------------- */
async function submitDone() {
  const checks = document.querySelectorAll("input[type=checkbox]");
  const done = [];

  checks.forEach((c, i) => {
    if (c.checked) done.push(undoneHomework[i]);
  });

  if (!done.length) {
    alert("å®Œäº†ã™ã‚‹å®¿é¡Œã‚’é¸ã‚“ã§ãã ã•ã„");
    return;
  }

  for (const text of done) {
    await postApi({
      action: "doneHomework",
      userId,
      text
    });
  }

  alert("å®Œäº†ç™»éŒ²ã—ã¾ã—ãŸ");
  showMenu();
}

init();
</script>
</body>
</html>
